<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前綴和 (Prefix Sum) 教學動畫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cell-transition {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 數列格子樣式 */
        .grid-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .number-box {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-weight: bold;
            font-family: monospace;
            font-size: 1rem;
            transition: all 0.3s;
            border-width: 2px;
        }

        @media (min-width: 768px) {
            .number-box {
                width: 3.5rem;
                height: 3.5rem;
                font-size: 1.125rem;
                border-radius: 0.75rem;
            }
        }

        /* 自定義滑桿 */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #db2777; /* pink-600 */
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }

        /* 動畫輔助 */
        .fade-in {
            animation: fadeIn 0.5s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-pink-50 min-h-screen font-sans text-slate-800">

    <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-8">
        
        <!-- Navigation -->
        <div class="flex justify-between items-center">
            <a href="index.html" class="inline-flex items-center gap-2 px-4 py-2 bg-white hover:bg-slate-100 rounded-lg shadow-sm border border-slate-200 transition-colors text-sm font-medium text-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                返回首頁
            </a>
        </div>
        
        <!-- Header / Lecture Notes -->
        <div class="bg-white rounded-2xl shadow-sm border-l-8 border-pink-500 p-6 md:p-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-6">前綴和 (Prefix Sum) 觀念解說</h1>
            
            <div class="grid md:grid-cols-2 gap-8 text-slate-600 leading-relaxed text-sm md:text-base">
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-pink-700 text-lg mb-2">1. 核心概念</h3>
                        <p>給你一段數列，要算出若干次任意一個區間的數字的總和，稱為<span class="font-bold text-slate-900">區間和</span>。</p>
                        <ul class="list-disc pl-5 mt-2 space-y-1">
                            <li>直接加總：耗費大量時間 (每次 O(N))。</li>
                            <li><span class="font-bold text-pink-600">前綴和處理</span>：先算出序列的前 n 項和。</li>
                            <li>效益：處理後，查詢區間和只需相減即可 (每次 O(1))，大幅節省時間。</li>
                        </ul>
                    </div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <h3 class="font-bold text-slate-700 text-lg mb-2">2. 數學定義</h3>
                    <div class="space-y-2 font-mono text-sm md:text-base">
                        <p><span class="bg-blue-100 text-blue-800 px-1 rounded">a[]</span> : 原始數列</p>
                        <p><span class="bg-pink-100 text-pink-800 px-1 rounded">b[]</span> : 前綴和數列 (b[i] 代表 a[0]~a[i] 的和)</p>
                        <hr class="border-slate-300 my-2">
                        <p class="font-bold text-pink-600">區間和 Sum(L, R) = b[R] - b[L-1]</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualization Container -->
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            
            <!-- Controls Header -->
            <div class="bg-slate-50 border-b border-slate-200 p-4 flex flex-wrap gap-4 justify-between items-center">
                <div class="flex items-center gap-2">
                    <span id="mode-badge" class="px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase bg-blue-100 text-blue-700">
                        1. 前置處理階段
                    </span>
                    <span id="status-text" class="text-sm text-slate-500 font-medium">
                        準備構建前綴和數列...
                    </span>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.reset()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-bold transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>
                        重置
                    </button>
                    <button id="action-btn" onclick="app.startBuild()" class="px-6 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg text-sm font-bold shadow-md shadow-pink-200 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        開始製作前綴和
                    </button>
                </div>
            </div>

            <div class="p-6 md:p-8 space-y-10">
                
                <!-- Array A -->
                <div class="relative">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="font-mono text-xl font-bold text-blue-600">a[]</span>
                        <span class="text-xs text-slate-400 uppercase tracking-wider font-bold">原始數列</span>
                    </div>
                    <div id="array-a-container" class="flex flex-wrap gap-2 md:gap-3">
                        <!-- JS will inject cells -->
                    </div>
                </div>

                <!-- Array B -->
                <div class="relative min-h-[100px]">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="font-mono text-xl font-bold text-pink-600">b[]</span>
                        <span class="text-xs text-slate-400 uppercase tracking-wider font-bold">前綴和數列</span>
                    </div>
                    <div id="array-b-container" class="flex flex-wrap gap-2 md:gap-3">
                        <!-- JS will inject cells -->
                    </div>
                </div>

                <!-- Interactive Panel (Bottom) -->
                <div class="grid md:grid-cols-2 gap-6 pt-6 border-t border-slate-100">
                    
                    <!-- Controls / Calculation Info -->
                    <div id="control-panel" class="bg-slate-50 p-6 rounded-xl border border-slate-200 min-h-[200px] flex flex-col justify-center">
                        <div class="text-center text-slate-400 italic">
                            點擊上方「開始製作前綴和」來啟動教學
                        </div>
                    </div>

                    <!-- Formula Display -->
                    <div class="bg-slate-900 p-6 rounded-xl text-white relative overflow-hidden flex flex-col justify-center min-h-[200px]">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
                        </div>
                        <h4 class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-4">公式運算</h4>
                        <div id="formula-display" class="font-mono text-lg md:text-xl space-y-2 z-10">
                            <span class="text-slate-500">等待開始...</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        const app = {
            // Data from the lecture notes
            a: [2, 3, 5, 7, 11, 13, 17, 19, 23, 29],
            b: [2, 5, 10, 17, 28, 41, 58, 77, 100, 129],
            
            state: {
                mode: 'idle', // 'idle', 'building', 'query'
                buildIndex: -1,
                queryL: 2,
                queryR: 6
            },
            
            timer: null,

            // DOM Elements
            dom: {
                containerA: document.getElementById('array-a-container'),
                containerB: document.getElementById('array-b-container'),
                controlPanel: document.getElementById('control-panel'),
                formulaDisplay: document.getElementById('formula-display'),
                actionBtn: document.getElementById('action-btn'),
                modeBadge: document.getElementById('mode-badge'),
                statusText: document.getElementById('status-text')
            },

            init() {
                this.renderArrays();
                this.updateUI();
            },

            reset() {
                clearInterval(this.timer);
                this.state.mode = 'idle';
                this.state.buildIndex = -1;
                this.state.queryL = 2;
                this.state.queryR = 6;
                this.updateUI();
                this.renderArrays();
            },

            startBuild() {
                if (this.state.mode === 'building') return;
                
                this.state.mode = 'building';
                this.state.buildIndex = -1;
                this.updateUI();

                this.timer = setInterval(() => {
                    this.state.buildIndex++;
                    
                    if (this.state.buildIndex >= this.a.length) {
                        clearInterval(this.timer);
                        this.state.mode = 'query';
                        // Small delay before switching UI to query mode completely
                        setTimeout(() => {
                            this.updateUI();
                            this.renderArrays();
                        }, 1000);
                    } else {
                        this.renderArrays();
                        this.updateFormulaBuild();
                    }
                }, 800); // Speed of animation
            },

            updateQuery(type, val) {
                val = parseInt(val);
                if (type === 'l') {
                    if (val <= this.state.queryR) this.state.queryL = val;
                    else { this.state.queryL = val; this.state.queryR = val; } // push R
                } else {
                    if (val >= this.state.queryL) this.state.queryR = val;
                    else { this.state.queryR = val; this.state.queryL = val; } // push L
                }
                this.renderArrays();
                this.updateFormulaQuery();
                this.updateControlsQuery(); // Need to re-render controls to update slider values
            },

            // --- Rendering Logic ---

            updateUI() {
                const { mode } = this.state;
                
                // Badge & Status
                if (mode === 'idle') {
                    this.dom.modeBadge.className = "px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase bg-slate-100 text-slate-500";
                    this.dom.modeBadge.innerText = "準備就緒";
                    this.dom.statusText.innerText = "等待啟動...";
                    this.dom.actionBtn.classList.remove('hidden');
                    this.dom.actionBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg> 開始製作前綴和`;
                    
                    this.dom.controlPanel.innerHTML = `<div class="text-center text-slate-400 italic">點擊上方按鈕開始</div>`;
                    this.dom.formulaDisplay.innerHTML = `<span class="text-slate-500">等待開始...</span>`;
                } 
                else if (mode === 'building') {
                    this.dom.modeBadge.className = "px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase bg-blue-100 text-blue-700";
                    this.dom.modeBadge.innerText = "1. 前置處理階段";
                    this.dom.statusText.innerText = "正在計算前綴和...";
                    this.dom.actionBtn.classList.add('hidden');
                    
                    this.dom.controlPanel.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full space-y-2">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-600"></div>
                            <p class="text-slate-600 font-medium">逐項累加中...</p>
                        </div>
                    `;
                } 
                else if (mode === 'query') {
                    this.dom.modeBadge.className = "px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase bg-pink-100 text-pink-700";
                    this.dom.modeBadge.innerText = "2. 區間查詢階段";
                    this.dom.statusText.innerText = "現在可以快速查詢任意區間和！";
                    this.dom.actionBtn.classList.add('hidden');
                    
                    this.updateControlsQuery();
                    this.updateFormulaQuery();
                }
            },

            updateControlsQuery() {
                // Generates the sliders for Query Mode
                const max = this.a.length - 1;
                this.dom.controlPanel.innerHTML = `
                    <div class="space-y-6 fade-in">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b border-slate-200">
                            <svg class="text-pink-600" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            <h3 class="font-bold text-slate-700">選擇查詢區間</h3>
                        </div>
                        
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-bold text-slate-500">起始位置 (L)</label>
                                <span class="font-mono font-bold text-pink-600 text-lg">${this.state.queryL}</span>
                            </div>
                            <input type="range" min="0" max="${max}" value="${this.state.queryL}" 
                                oninput="app.updateQuery('l', this.value)" class="w-full">
                        </div>

                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-bold text-slate-500">結束位置 (R)</label>
                                <span class="font-mono font-bold text-pink-600 text-lg">${this.state.queryR}</span>
                            </div>
                            <input type="range" min="0" max="${max}" value="${this.state.queryR}" 
                                oninput="app.updateQuery('r', this.value)" class="w-full">
                        </div>
                        
                        <div class="text-xs text-center text-slate-400 mt-2">
                            拖動滑桿觀察數列變化
                        </div>
                    </div>
                `;
            },

            updateFormulaBuild() {
                const i = this.state.buildIndex;
                if(i < 0) return;

                let prevFormula = i > 0 ? `b[${i-1}]` : `0`;
                let prevVal = i > 0 ? this.b[i-1] : 0;
                let currentA = this.a[i];
                let currentB = this.b[i];

                this.dom.formulaDisplay.innerHTML = `
                    <div class="fade-in">
                        <div class="text-slate-400 text-sm mb-1">b[${i}] = ${prevFormula} + a[${i}]</div>
                        <div class="text-2xl font-bold">
                            <span class="text-white">${currentB}</span> 
                            = <span class="text-yellow-400">${prevVal}</span> 
                            + <span class="text-blue-400">${currentA}</span>
                        </div>
                    </div>
                `;
            },

            updateFormulaQuery() {
                const { queryL, queryR } = this.state;
                const bR = this.b[queryR];
                const bL_1 = queryL > 0 ? this.b[queryL-1] : 0;
                const result = bR - bL_1;
                const idxL_1 = queryL - 1;

                this.dom.formulaDisplay.innerHTML = `
                    <div class="fade-in space-y-4">
                        <div>
                            <div class="text-slate-400 text-sm mb-1">區間和 Sum(${queryL}, ${queryR})</div>
                            <div class="text-lg">
                                = <span class="text-green-400 font-bold">b[${queryR}]</span> - <span class="text-red-400 font-bold">b[${idxL_1 < 0 ? '無' : idxL_1}]</span>
                            </div>
                        </div>
                        <div class="text-3xl font-bold border-t border-slate-700 pt-2">
                            = ${bR} - ${bL_1}
                            <br>
                            = <span class="text-pink-400">${result}</span>
                        </div>
                    </div>
                `;
            },

            renderArrays() {
                const { mode, buildIndex, queryL, queryR } = this.state;

                // Render A
                this.dom.containerA.innerHTML = this.a.map((val, idx) => {
                    let activeClass = "bg-white border-slate-200 text-slate-600";
                    let scaleClass = "scale-100";
                    
                    if (mode === 'building' && idx === buildIndex) {
                        activeClass = "bg-blue-100 border-blue-500 text-blue-700 shadow-md";
                        scaleClass = "scale-110";
                    } else if (mode === 'query') {
                        if (idx >= queryL && idx <= queryR) {
                            activeClass = "bg-blue-50 border-blue-400 text-blue-800";
                        }
                    }

                    return `
                        <div class="grid-cell">
                            <div class="text-xs text-slate-400 font-mono mb-1">${idx}</div>
                            <div class="number-box ${activeClass} ${scaleClass}">
                                ${val}
                            </div>
                        </div>
                    `;
                }).join('');

                // Render B
                this.dom.containerB.innerHTML = this.b.map((val, idx) => {
                    // Visibility
                    const isVisible = (mode === 'building' && idx <= buildIndex) || mode === 'query';
                    
                    if (!isVisible) {
                        return `
                             <div class="grid-cell opacity-0">
                                <div class="text-xs font-mono mb-1">${idx}</div>
                                <div class="number-box border-transparent"></div>
                            </div>
                        `;
                    }

                    let activeClass = "bg-pink-50 border-pink-200 text-pink-800";
                    let label = "";
                    let scaleClass = "scale-100";

                    if (mode === 'building' && idx === buildIndex) {
                        activeClass = "bg-pink-500 border-pink-600 text-white shadow-lg";
                        scaleClass = "scale-110";
                    } 
                    else if (mode === 'query') {
                        if (idx === queryR) {
                            activeClass = "bg-green-100 border-green-500 text-green-800 shadow-md border-2";
                            label = `<div class="absolute -bottom-6 text-xs font-bold text-green-600">b[R]</div>`;
                        } else if (idx === queryL - 1) {
                            activeClass = "bg-red-100 border-red-500 text-red-800 shadow-md border-2";
                            label = `<div class="absolute -bottom-6 text-xs font-bold text-red-600">b[L-1]</div>`;
                        }
                    }

                    return `
                        <div class="grid-cell fade-in">
                            <div class="text-xs text-slate-400 font-mono mb-1">${idx}</div>
                            <div class="number-box ${activeClass} ${scaleClass}">
                                ${val}
                            </div>
                            ${label}
                        </div>
                    `;
                }).join('');
            }
        };

        app.init();
    </script>
</body>
</html>