<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>區間和問題 (Range Sum Query) 視覺化</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定義過渡效果，讓動畫更滑順 */
        .transition-all-300 {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .transition-all-500 {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 隱藏元素動畫起始狀態 */
        .hidden-anim {
            opacity: 0;
            transform: translateY(1rem);
        }
        .show-anim {
            opacity: 1;
            transform: translateY(0);
        }

        /* 範圍滑桿樣式 */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5; /* indigo-600 */
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0; /* slate-200 */
            border-radius: 2px;
        }

        input[type=range]:focus {
            outline: none;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">

    <div class="max-w-4xl mx-auto p-4 md:p-8 space-y-8">
        
        <!-- Header -->
        <div class="text-center space-y-2">
            <h1 class="text-3xl font-bold text-slate-900">區間和問題 (Range Sum Query)</h1>
            <p class="text-slate-600">
                利用 <span class="font-bold text-indigo-600">前綴和 (Prefix Sum)</span> 技巧，將查詢時間複雜度從 O(N) 降至 O(1)。
            </p>
        </div>

        <!-- Main Visualization Area -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 border border-slate-200">
            
            <!-- Top Controls (Reset & Status) -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div class="flex gap-2">
                    <button onclick="app.generateRandomArray()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-sm font-medium transition-colors">
                        隨機陣列
                    </button>
                    <button onclick="app.reset()" class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors" title="重置">
                        <!-- Icon: RotateCcw -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>
                    </button>
                </div>
                
                <div class="flex items-center gap-2">
                    <span id="badge-build" class="px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase bg-blue-100 text-blue-700 transition-colors">
                        1. 預處理 (O(N))
                    </span>
                    <!-- Icon: ArrowRight -->
                    <svg class="text-slate-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    <span id="badge-query" class="px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase bg-slate-100 text-slate-400 transition-colors">
                        2. 查詢 (O(1))
                    </span>
                </div>
            </div>

            <!-- Arrays Container -->
            <div class="space-y-12">
                
                <!-- Original Array (A) -->
                <div class="relative">
                    <h3 class="text-sm font-semibold text-slate-500 mb-2 uppercase tracking-wider flex items-center gap-2">
                        原始陣列 (A)
                        <span id="calculating-badge" class="hidden text-xs normal-case bg-amber-100 text-amber-700 px-2 py-0.5 rounded">正在計算...</span>
                    </h3>
                    <div id="array-container" class="flex flex-wrap gap-2 md:gap-4">
                        <!-- JS will inject cells here -->
                    </div>
                </div>

                <!-- Prefix Sum Array (P) -->
                <div class="relative">
                    <div class="flex items-center gap-2 mb-2">
                        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider">前綴和陣列 (P)</h3>
                        <div class="group relative inline-block">
                            <!-- Icon: Info -->
                            <svg class="text-slate-400 cursor-help" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                            <div class="absolute left-0 bottom-full mb-2 w-64 bg-slate-800 text-white text-xs p-3 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                P[i] 代表原始陣列從索引 0 到 i 的總和。<br/>
                                P[i] = P[i-1] + A[i]
                            </div>
                        </div>
                    </div>

                    <div id="prefix-container" class="flex flex-wrap gap-2 md:gap-4">
                        <!-- JS will inject cells here -->
                    </div>
                </div>

            </div>
        </div>

        <!-- Bottom Panel: Controls & Formula -->
        <div class="grid md:grid-cols-2 gap-6">
            
            <!-- Left: Interactive Controls -->
            <div id="control-panel" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 min-h-[250px] flex flex-col justify-center">
                <!-- Content injected by JS based on mode -->
            </div>

            <!-- Right: Math & Formula Display -->
            <div class="bg-indigo-900 p-6 rounded-2xl shadow-xl text-white relative overflow-hidden min-h-[250px]">
                <div class="absolute top-0 right-0 p-3 opacity-10 pointer-events-none">
                    <!-- Icon: Calculator -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
                </div>

                <div class="relative z-10 h-full flex flex-col justify-between">
                    <div>
                        <h3 id="formula-title" class="text-indigo-200 uppercase text-xs font-bold tracking-widest mb-4">
                            計算邏輯
                        </h3>
                        <div id="formula-content">
                            <!-- Formula injected by JS -->
                        </div>
                    </div>
                    
                    <div id="formula-note" class="mt-4 text-xs text-indigo-300 hidden">
                        * 當 L=0 時，P[L-1] 視為 0
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // 應用程式核心邏輯
        const app = {
            // State
            data: [3, 1, 4, 1, 5, 9, 2],
            prefixSum: [],
            range: { l: 2, r: 5 },
            mode: 'build', // 'build' | 'query'
            buildStep: -1,
            isPlaying: false,
            timer: null,

            // DOM Elements Cache
            dom: {
                arrayContainer: document.getElementById('array-container'),
                prefixContainer: document.getElementById('prefix-container'),
                controlPanel: document.getElementById('control-panel'),
                formulaContent: document.getElementById('formula-content'),
                formulaTitle: document.getElementById('formula-title'),
                formulaNote: document.getElementById('formula-note'),
                badgeBuild: document.getElementById('badge-build'),
                badgeQuery: document.getElementById('badge-query'),
                calcBadge: document.getElementById('calculating-badge')
            },

            init() {
                this.calculatePrefixSum();
                this.render();
            },

            calculatePrefixSum() {
                this.prefixSum = [];
                let currentSum = 0;
                for (let num of this.data) {
                    currentSum += num;
                    this.prefixSum.push(currentSum);
                }
            },

            generateRandomArray() {
                this.data = Array.from({ length: 7 }, () => Math.floor(Math.random() * 9) + 1);
                this.calculatePrefixSum();
                this.reset();
            },

            reset() {
                this.stopAnimation();
                this.mode = 'build';
                this.buildStep = -1;
                this.range = { l: 2, r: Math.min(5, this.data.length - 1) };
                this.render();
            },

            startBuilding() {
                if (this.buildStep === this.data.length - 1) {
                    this.mode = 'query';
                    this.render();
                    return;
                }
                
                this.buildStep = -1;
                this.isPlaying = true;
                this.render(); // Update UI to show "playing" state

                if (this.timer) clearInterval(this.timer);
                
                this.timer = setInterval(() => {
                    if (this.buildStep < this.data.length - 1) {
                        this.buildStep++;
                        this.render();
                    } else {
                        this.stopAnimation();
                        this.mode = 'query';
                        this.render();
                    }
                }, 1000);
            },

            stopAnimation() {
                this.isPlaying = false;
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
            },

            updateRange(type, value) {
                const val = Number(value);
                if (type === 'l') {
                    // Ensure L <= R
                    if (val <= this.range.r) {
                        this.range.l = val;
                    } else {
                        // Prevent crossing, or push R
                        this.range.l = val;
                        this.range.r = val;
                    }
                } else if (type === 'r') {
                    // Ensure R >= L
                    if (val >= this.range.l) {
                        this.range.r = val;
                    } else {
                        this.range.r = val;
                        this.range.l = val;
                    }
                }
                this.render();
            },

            calculateResult() {
                const rightSum = this.prefixSum[this.range.r];
                const leftSum = this.range.l > 0 ? this.prefixSum[this.range.l - 1] : 0;
                return rightSum - leftSum;
            },

            // --- Rendering Functions ---

            render() {
                this.renderBadges();
                this.renderArrayGrid();
                this.renderPrefixGrid();
                this.renderControls();
                this.renderFormula();
            },

            renderBadges() {
                if (this.mode === 'build') {
                    this.dom.badgeBuild.className = "px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase bg-blue-100 text-blue-700 transition-colors";
                    this.dom.badgeQuery.className = "px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase bg-slate-100 text-slate-400 transition-colors";
                    if (this.isPlaying) {
                        this.dom.calcBadge.classList.remove('hidden');
                    } else {
                        this.dom.calcBadge.classList.add('hidden');
                    }
                } else {
                    this.dom.badgeBuild.className = "px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase bg-slate-100 text-slate-400 transition-colors";
                    this.dom.badgeQuery.className = "px-3 py-1 rounded-full text-xs font-bold tracking-wide uppercase bg-green-100 text-green-700 transition-colors";
                    this.dom.calcBadge.classList.add('hidden');
                }
            },

            renderArrayGrid() {
                this.dom.arrayContainer.innerHTML = this.data.map((val, idx) => {
                    const isCurrentBuildStep = this.mode === 'build' && idx === this.buildStep;
                    const isInQueryRange = this.mode === 'query' && idx >= this.range.l && idx <= this.range.r;
                    
                    let bgClass = 'bg-white border-slate-200 text-slate-700';
                    let shadowClass = 'shadow-sm';
                    let scaleClass = 'scale-100';

                    if (isCurrentBuildStep) {
                        bgClass = 'bg-blue-500 border-blue-600 text-white';
                        scaleClass = 'scale-110';
                        shadowClass = 'shadow-blue-200 shadow-lg';
                    } else if (isInQueryRange) {
                        bgClass = 'bg-blue-50 border-blue-400 text-blue-700';
                    }

                    return `
                        <div class="flex flex-col items-center gap-1">
                            <div class="text-xs text-slate-400 font-mono">idx ${idx}</div>
                            <div class="w-12 h-12 md:w-16 md:h-16 flex items-center justify-center rounded-xl text-xl font-bold border-2 transition-all-300 ${bgClass} ${scaleClass} ${shadowClass}">
                                ${val}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderPrefixGrid() {
                this.dom.prefixContainer.innerHTML = this.data.map((_, idx) => {
                    const isVisible = this.mode === 'query' || (this.mode === 'build' && idx <= this.buildStep);
                    const isCalculating = this.mode === 'build' && idx === this.buildStep;
                    
                    const isR = this.mode === 'query' && idx === this.range.r;
                    const isLMinusOne = this.mode === 'query' && idx === this.range.l - 1;

                    let containerClass = isVisible ? 'show-anim' : 'hidden-anim';
                    let cellClass = 'bg-slate-100 border-slate-200 text-slate-600';
                    let label = '';

                    if (isCalculating) {
                        cellClass = 'bg-indigo-600 text-white scale-110';
                    } else if (isR) {
                        cellClass = 'bg-green-100 border-green-500 text-green-700 shadow-green-100 border-2';
                        label = '<div class="text-xs font-bold text-green-600 mt-1">P[R]</div>';
                    } else if (isLMinusOne) {
                        cellClass = 'bg-red-100 border-red-500 text-red-700 shadow-red-100 border-2';
                        label = '<div class="text-xs font-bold text-red-600 mt-1">P[L-1]</div>';
                    } else if (isVisible) {
                        // Default visible
                        cellClass = 'bg-slate-100 border-slate-200 text-slate-600 border';
                    }

                    return `
                        <div class="flex flex-col items-center gap-1 transition-all-500 ${containerClass}">
                            <div class="w-12 h-12 md:w-16 md:h-16 flex items-center justify-center rounded-xl text-lg font-bold transition-all-300 ${cellClass}">
                                ${this.prefixSum[idx]}
                            </div>
                            ${label}
                        </div>
                    `;
                }).join('');
            },

            renderControls() {
                if (this.mode === 'build') {
                    // Build Mode Controls
                    const btnContent = this.buildStep === -1 
                        ? `<svg class="mr-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg> 開始構建動畫`
                        : `<svg class="mr-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg> 繼續構建`;
                    
                    const btnClass = this.isPlaying 
                        ? 'bg-slate-400 cursor-not-allowed' 
                        : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-lg hover:-translate-y-1';

                    this.dom.controlPanel.innerHTML = `
                        <div class="h-full flex flex-col justify-center items-center text-center space-y-4 fade-in">
                            <div class="text-lg font-medium text-slate-800">第一步：建立前綴和陣列</div>
                            <p class="text-slate-500 text-sm">我們需要計算每個位置累積的總和，這樣之後才能快速查詢。</p>
                            <button onclick="app.startBuilding()" ${this.isPlaying ? 'disabled' : ''} 
                                class="flex items-center gap-2 px-6 py-3 rounded-full font-bold text-white shadow-md transition-all ${btnClass}">
                                ${btnContent}
                            </button>
                        </div>
                    `;
                } else {
                    // Query Mode Controls
                    const subArray = this.data.slice(this.range.l, this.range.r + 1);
                    const subArrayHtml = subArray.map(v => `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-mono">${v}</span>`).join('');

                    this.dom.controlPanel.innerHTML = `
                        <div class="space-y-6 w-full fade-in">
                            <div class="flex items-center gap-2 text-lg font-medium text-slate-800 border-b pb-2">
                                <svg class="text-green-600" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></svg>
                                第二步：選擇查詢區間
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">起始索引 (L)</label>
                                    <input type="range" min="0" max="${this.data.length - 1}" value="${this.range.l}" 
                                        oninput="app.updateRange('l', this.value)" class="w-full h-2 bg-slate-200 rounded-lg accent-indigo-600">
                                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                                        <span>0</span>
                                        <span class="font-mono text-indigo-600 font-bold text-base">${this.range.l}</span>
                                        <span>${this.data.length - 1}</span>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">結束索引 (R)</label>
                                    <input type="range" min="0" max="${this.data.length - 1}" value="${this.range.r}" 
                                        oninput="app.updateRange('r', this.value)" class="w-full h-2 bg-slate-200 rounded-lg accent-indigo-600">
                                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                                        <span>0</span>
                                        <span class="font-mono text-indigo-600 font-bold text-base">${this.range.r}</span>
                                        <span>${this.data.length - 1}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-100">
                                <p class="text-sm text-slate-600 mb-2">查詢範圍：</p>
                                <div class="flex gap-2 flex-wrap">
                                    ${subArrayHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            renderFormula() {
                this.dom.formulaTitle.textContent = this.mode === 'build' ? '計算邏輯' : '數學公式';
                
                if (this.mode === 'build') {
                    this.dom.formulaNote.classList.add('hidden');
                    if (this.buildStep === -1) {
                        this.dom.formulaContent.innerHTML = `<p class="text-indigo-100">準備開始構建前綴和數組...</p>`;
                    } else {
                        const prevSum = this.buildStep > 0 ? this.prefixSum[this.buildStep - 1] : 0;
                        const currentVal = this.data[this.buildStep];
                        const result = this.prefixSum[this.buildStep];
                        
                        this.dom.formulaContent.innerHTML = `
                            <div class="font-mono text-xl md:text-2xl space-y-2 fade-in">
                                <div>
                                    P[${this.buildStep}] = <span class="text-yellow-300">P[${this.buildStep-1}]</span> + <span class="text-blue-300">A[${this.buildStep}]</span>
                                </div>
                                <div class="text-slate-300 text-lg">
                                    ${prevSum} + ${currentVal} = <span class="font-bold text-white">${result}</span>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    this.dom.formulaNote.classList.remove('hidden');
                    const pR = this.prefixSum[this.range.r];
                    const pLMinus1 = this.range.l > 0 ? this.prefixSum[this.range.l - 1] : 0;
                    const result = this.calculateResult();
                    const lMinus1Idx = this.range.l > 0 ? this.range.l - 1 : 0;

                    this.dom.formulaContent.innerHTML = `
                        <div class="space-y-6 fade-in">
                            <div>
                                <div class="text-indigo-300 text-sm mb-1">通用公式：</div>
                                <div class="font-mono text-lg bg-indigo-800/50 p-2 rounded inline-block">
                                    Sum(L, R) = P[R] - P[L-1]
                                </div>
                            </div>

                            <div class="space-y-2">
                                <div class="text-indigo-300 text-sm">代入數值：</div>
                                <div class="font-mono text-xl md:text-2xl">
                                    Sum(${this.range.l}, ${this.range.r}) <br/>
                                    = <span class="text-green-400">P[${this.range.r}]</span> - <span class="text-red-400">${this.range.l > 0 ? `P[${lMinus1Idx}]` : '0'}</span>
                                </div>
                                <div class="font-mono text-xl md:text-2xl border-t border-indigo-700 pt-2 mt-2">
                                     = ${pR} - ${pLMinus1} <br/>
                                     = <span class="text-yellow-400 font-bold text-4xl ml-2">${result}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        };

        // Initialize App
        app.init();

    </script>
</body>
</html>